machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker

dependencies:
  override:
    - /bin/true

test:
  override:
    - /bin/sh ./scripts/run.sh test_and_build
    - docker build -t utilitywarehouse/$CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1 .

deployment:
  publish:
    branch: master
    commands:
      - docker tag utilitywarehouse/$CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1 utilitywarehouse/$CIRCLE_PROJECT_REPONAME:latest
      - docker login -e none@none.com -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD
      - docker push utilitywarehouse/$CIRCLE_PROJECT_REPONAME
      - >-
        KUBERNETES_URL=$KUBERNETES_URL_DEV
        KUBERNETES_TOKEN=$KUBERNETES_TOKEN_DEV
        /bin/sh ./scripts/deploy.sh $KUBERNETES_URL $CIRCLE_PROJECT_REPONAME $CIRCLE_SHA1
